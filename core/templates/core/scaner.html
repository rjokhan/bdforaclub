{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–°–ö–ê–ù–ï–†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <link rel="stylesheet" href="{% static 'core/base.css' %}">
  <style>
    /* --- —Å–∫–∞–Ω–µ—Ä --- */
    html, body { height: 100%; }
    body { margin:0; background:#111; color:#fff; overflow:hidden; }

    /* –±–ª–æ–∫–∏—Ä—É–µ–º –¥–≤–æ–π–Ω–æ–π —Ç–∞–ø-–∑—É–º –Ω–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–∞—Ö */
    button, .btn, [role="button"] { touch-action: manipulation; }

    .scanner-root {
      position: relative;
      width: 100%;
      height: 100%;
      display: grid;
      place-items: center;
    }

    /* —Ñ–æ–Ω, –æ—Å—Ç–∞–≤–ª—è–µ–º –≤–∞—à */
    .vertical-waves { position:absolute; inset:0; z-index:0; }

    /* –≤–∏–¥–µ–æ —Å –∫–∞–º–µ—Ä—ã */
    #preview {
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit: cover;
      background:#000;
      z-index:1;
    }

    /* –Ω–∞–∫–ª–∞–¥–∫–∞ —Å —Ä–∞–º–∫–æ–π */
    .overlay {
      position:absolute; inset:0; z-index:2;
      display:grid; place-items:center;
      pointer-events:none;
    }

    .qr-frame {
      position: relative;
      width: min(72vw, 420px);
      aspect-ratio: 1/1;
      border: 3px solid rgba(255,255,255,0.9);
      border-radius: 14px;
      box-shadow:
        0 0 0 200vmax rgba(0,0,0,.45) inset,
        0 12px 28px rgba(0,0,0,.35);
    }

    .hint {
      position:absolute; top:-42px; left:50%; transform:translateX(-50%);
      font-family: Inter, system-ui, -apple-system, Arial;
      font-size: 13px; letter-spacing:.5px; text-transform:uppercase;
      text-shadow: 0 1px 2px rgba(0,0,0,.6);
      white-space: nowrap;
    }

    /* –±–µ–≥—É—â–∞—è –ª–∏–Ω–∏—è ‚Äî loop with reverse */
    .scanline {
      position:absolute; left:8px; right:8px; height:2px; top:10%;
      background: rgba(82,255,144,1);
      box-shadow: 0 0 12px rgba(82,255,144,.9), 0 0 24px rgba(82,255,144,.6);
      border-radius:2px;
      animation: sweep 2.2s linear infinite alternate;
    }
    @keyframes sweep {
      0%   { top:10%; }
      100% { top:calc(90% - 2px); }
    }

    /* –∫–Ω–æ–ø–∫–∏ */
    .controls {
      position: absolute; left:0; right:0; bottom: 24px; z-index:3;
      display:flex; gap:10px; justify-content:center; padding:0 16px;
      pointer-events:auto;
    }
    .btn {
      flex:1; max-width: 200px;
      padding:12px 14px; border-radius:12px; border:1px solid #d9d9d9;
      background:#fff; color:#222; font-weight:700; cursor:pointer;
      font-family: Inter, system-ui, -apple-system, Arial;
    }
    .btn.primary { background:#be0036; color:#fff; border-color:#be0036; }
    .btn.dark { background:#3b3b3b; color:#fff; border-color:#3b3b3b; }

    .status {
      position:absolute; top:14px; left:50%; transform:translateX(-50%);
      z-index:3; font-size:13px; color:#d7d7d7; text-align:center;
      padding:6px 10px; background:rgba(0,0,0,.35); border-radius:10px;
      backdrop-filter: blur(4px);
    }

    /* --- –Ω–∏–∂–Ω–∏–π –ø–æ–ø–∞–ø (bottom sheet) --- */
    .sheet-backdrop {
      position: fixed; inset:0; background: rgba(0,0,0,.35);
      z-index: 9; opacity:0; pointer-events:none; transition: opacity .25s ease;
    }
    .sheet {
      position: fixed; left:0; right:0; bottom:0; z-index: 10;
      transform: translateY(100%);
      transition: transform .28s cubic-bezier(.22,.65,.25,1);
      background:#fff; color:#111; border-radius: 16px 16px 0 0;
      box-shadow: 0 -16px 50px rgba(0,0,0,.35);
      padding: 16px 16px 22px;
      font-family: Inter, system-ui, -apple-system, Arial;
    }
    .sheet.open { transform: translateY(0%); }
    .sheet-backdrop.open { opacity:1; pointer-events:auto; }

    .sheet .badge {
      width:95%; text-align:center; font-weight:800;
      margin-left: auto; margin-right: auto;
      padding:12px 10px; border-radius:10px; margin-bottom:12px;
      text-transform:uppercase; letter-spacing:.5px;
    }
    .sheet .badge.ok  { background:#d6f5e3; color:#0a7a34; border:1px solid #bde8cf; }
    .sheet .badge.err { background:#ffd7d7; color:#a40020; border:1px solid #f3b2b2; }

    .sheet .kv { font-size:14px; line-height:1.65; }
    .sheet .kv b { display:inline-block; min-width:118px; color:#444; }

    .sheet .row { display:flex; gap:10px; margin-top:14px; }
    .sheet .row .btn { flex:1; }
  </style>
</head>
<body>
  <div class="scanner-root">
    <div class="vertical-waves" aria-hidden="true">
      <div class="wave"></div><div class="wave"></div><div class="wave"></div>
    </div>

    <video id="preview" playsinline muted></video>

    <div class="overlay" aria-hidden="true">
      <div class="qr-frame">
        <div class="hint">–ù–ê–í–ï–î–ò–¢–ï QR –ö–û–î –í –†–ê–ú–ö–£</div>
        <div class="scanline"></div>
      </div>
    </div>

    <div id="status" class="status">–ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞.</div>

    <div class="controls">
      <button id="startBtn" class="btn primary">–í–∫–ª—é—á–∏—Ç—å —Å–∫–∞–Ω–µ—Ä</button>
      <button id="torchBtn" class="btn">–§–æ–Ω–∞—Ä–∏–∫</button>
      <button id="stopBtn"  class="btn">–í—ã–∫–ª—é—á–∏—Ç—å</button>
    </div>
  </div>

  <!-- Backdrop + Bottom Sheet -->
  <div id="sheetBackdrop" class="sheet-backdrop"></div>
  <div id="sheet" class="sheet" role="dialog" aria-modal="true" aria-live="polite">
    <div id="sheetBadge" class="badge">‚Ä¶</div>
    <div id="sheetBody" class="kv"></div>
    <div class="row">
      <button id="scanAgainBtn" class="btn dark">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –µ—â—ë</button>
      <button id="closeBtn" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <!-- –§–æ–ª–±—ç–∫ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ QR -->
  <script src="https://unpkg.com/@zxing/browser@latest"></script>
  <script>
    // –í–∞—à –ø—Ä–æ–¥-—ç–Ω–¥–ø–æ–∏–Ω—Ç:
    const API_URL = "/qr/validate/";

    const video = document.getElementById('preview');
    const startBtn = document.getElementById('startBtn');
    const stopBtn  = document.getElementById('stopBtn');
    const torchBtn = document.getElementById('torchBtn');
    const statusEl = document.getElementById('status');

    const sheet = document.getElementById('sheet');
    const sheetBackdrop = document.getElementById('sheetBackdrop');
    const sheetBadge = document.getElementById('sheetBadge');
    const sheetBody  = document.getElementById('sheetBody');
    const scanAgainBtn = document.getElementById('scanAgainBtn');
    const closeBtn  = document.getElementById('closeBtn');

    let stream = null, track = null, scanning = false, stopFallback = null, torchOn = false;

    function setStatus(msg, ok=null){
      statusEl.textContent = msg;
      statusEl.style.color = ok===true ? '#8fffb0' : ok===false ? '#ffb3b3' : '#d7d7d7';
    }

    function openSheet(){ sheet.classList.add('open'); sheetBackdrop.classList.add('open'); }
    function closeSheet(){ sheet.classList.remove('open'); sheetBackdrop.classList.remove('open'); }

    function showOK(data){
      sheetBadge.className = 'badge ok';
      sheetBadge.textContent = '–ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û!';
      sheetBody.innerHTML = [
        data.full_name ? `<div><b>–†–µ–∑–∏–¥–µ–Ω—Ç:</b> ${data.full_name}</div>` : '',
        data.phone     ? `<div><b>–ù–æ–º–µ—Ä:</b> ${data.phone}</div>` : '',
        data.event     ? `<div><b>–ò–≤–µ–Ω—Ç:</b> ${data.event}</div>` : '',
        data.amount    ? `<div><b>–°—É–º–º–∞ –æ–ø–ª–∞—Ç—ã:</b> ${data.amount}</div>` : '',
        (data.booking_id ?? data.booking_id===0) ? `<div><b>ID –±—Ä–æ–Ω–∏:</b> ${data.booking_id}</div>` : ''
      ].join('');
      openSheet();
      navigator.vibrate?.(80);
    }

    function showERR(reason){
      sheetBadge.className = 'badge err';
      sheetBadge.textContent = '–ù–ï –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û!';
      sheetBody.innerHTML = `<div><b>–ü—Ä–∏—á–∏–Ω–∞ –æ—à–∏–±–∫–∏:</b> ${reason || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</div>`;
      openSheet();
      navigator.vibrate?.([60,40,60]);
    }

    async function startCamera(){
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: 'environment' }, width:{ ideal:1280 }, height:{ ideal:720 } },
        audio: false
      });
      video.srcObject = stream;
      await video.play();
      track = stream.getVideoTracks()[0];
    }

    function stopScan(){
      scanning = false;
      if (stopFallback){ try{ stopFallback(); }catch{} stopFallback=null; }
      if (track){ track.stop(); track=null; }
      if (stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
      video.srcObject = null;
      setStatus('–ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞.');
    }

    async function toggleTorch(){
      if (!track) return setStatus('–§–æ–Ω–∞—Ä–∏–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–∫–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞)');
      const caps = track.getCapabilities?.();
      if (!caps || !caps.torch) return setStatus('–§–æ–Ω–∞—Ä–∏–∫ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ');
      torchOn = !torchOn;
      await track.applyConstraints({ advanced:[{ torch: torchOn }] });
      torchBtn.textContent = torchOn ? '–§–æ–Ω–∞—Ä–∏–∫ –≤—ã–∫–ª' : '–§–æ–Ω–∞—Ä–∏–∫';
    }

    // –†–∞–∑–±–æ—Ä QR ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ API –ë–ï–ó hash
   async function handleDecoded(qr) {
    stopScanner();

    let payloadNoHash;
    try {
        payloadNoHash = JSON.parse(qr);
        if (payloadNoHash.hash) {
            delete payloadNoHash.hash;
        }
    } catch (e) {
        setStatus('QR –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–∞–ª–∏–¥–Ω—ã–π JSON', false);
        return;
    }

    console.log("üì¶ Payload –±–µ–∑ hash:", payloadNoHash);

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
    function pick(...args) {
        return args.find(v => v !== undefined && v !== null && v !== '');
    }

    function buildSuccessView(data, qrOrPayload) {
        console.log("‚úÖ API success payload:", data);

        const name  = pick(data.full_name, data.user_name, data.user?.full_name, data.name);
        const phone = pick(data.phone, data.phone_number, data.user?.phone);
        const eventTitle = pick(data.event_title, data.event_name, data.event?.title, data.event);
        const amountRaw  = pick(data.amount_text, data.amount_formatted, data.total_amount_text);
        const amountNum  = pick(data.amount, data.total_amount, data.price, data.paid_amount);
        const amount = amountRaw || (Number.isFinite(Number(amountNum)) ? `${amountNum} —Å—É–º` : undefined);
        const bookingId = pick(
            data.booking_id,
            data.purchase_id,
            data.order_id,
            qrOrPayload?.purchase_id,
            qrOrPayload?.transaction_id
        );

        showOK({
            full_name: name || '‚Äî',
            phone: phone || '‚Äî',
            event: eventTitle || '‚Äî',
            amount: amount || '‚Äî',
            booking_id: bookingId ?? '‚Äî'
        });
        setStatus('QR –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω', true);
    }

    try {
        // –ó–∞–ø—Ä–æ—Å –∫ –ø—Ä–æ–∫—Å–∏
        const res = await fetch('/qr/validate/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payloadNoHash)
        });

        let data;
        try {
            data = await res.json();
        } catch (e) {
            setStatus('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞', false);
            return;
        }

        if (res.status === 200) {
            buildSuccessView(data, payloadNoHash);
            return;
        } else {
            console.warn("‚ùå –ü–µ—Ä–≤–∏—á–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ –ø—Ä–æ—à–ª–∞:", data);
        }

        // –í—Ç–æ—Ä–æ–π —à–∞–Ω—Å ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å hash
        if (payloadNoHash && !payloadNoHash.hash && qr.includes('"hash"')) {
            try {
                const payloadWithHash = JSON.parse(qr);
                const res2 = await fetch('/qr/validate/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payloadWithHash)
                });
                const data2 = await res2.json();
                if (res2.status === 200) {
                    buildSuccessView(data2, payloadWithHash);
                    return;
                } else {
                    console.warn("‚ùå –í—Ç–æ—Ä–∏—á–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ –ø—Ä–æ—à–ª–∞:", data2);
                }
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å hash:", e);
            }
        }

        setStatus(data.detail || 'QR –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω', false);

    } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", err);
        setStatus('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞', false);
    }
}


    async function startScan(){
      if (scanning) return;
      closeSheet();
      await startCamera();
      scanning = true;
      setStatus('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ‚Ä¶ –Ω–∞–≤–µ–¥–∏—Ç–µ QR –≤ —Ä–∞–º–∫—É');

      // 1) –ù–∞—Ç–∏–≤–Ω—ã–π –¥–µ—Ç–µ–∫—Ç–æ—Ä
      if ('BarcodeDetector' in window){
        try{
          const det = new BarcodeDetector({ formats:['qr_code'] });
          const loop = async ()=>{
            if (!scanning) return;
            try{
              const codes = await det.detect(video);
              if (codes.length) return handleDecoded(codes[0].rawValue || '');
            }catch{}
            requestAnimationFrame(loop);
          };
          loop();
          return;
        }catch{}
      }

      // 2) ZXing —Ñ–æ–ª–±—ç–∫
      const reader = new ZXingBrowser.BrowserMultiFormatReader();
      const controls = await reader.decodeFromVideoDevice(null, video, (result, err, ctrls)=>{
        stopFallback = () => ctrls.stop();
        if (result) handleDecoded(result.getText());
      });
    }

    // —Å–æ–±—ã—Ç–∏—è UI
    startBtn.onclick = ()=> startScan().catch(e=> setStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É: ' + e.message, false));
    stopBtn.onclick  = ()=> { stopScan(); };
    torchBtn.onclick = ()=> toggleTorch();

    scanAgainBtn.onclick = ()=> startScan().catch(e=> setStatus('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: ' + e.message, false));
    closeBtn.onclick = ()=> closeSheet();
    sheetBackdrop.onclick = ()=> closeSheet();

    // –ë–ª–æ–∫–∏—Ä—É–µ–º double‚Äëtap zoom –∏ –∂–µ—Å—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è (iOS Safari)
    document.addEventListener('dblclick', e => e.preventDefault(), { passive:false });
    let lastTouchEnd = 0;
    document.addEventListener('touchend', e => {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) e.preventDefault();
      lastTouchEnd = now;
    }, { passive:false });
    document.addEventListener('gesturestart', e => e.preventDefault(), { passive:false });
  </script>
</body>
</html>
