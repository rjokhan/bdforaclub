{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>События</title>
    <link rel="stylesheet" href="{% static 'core/base.css' %}">
    <link rel="stylesheet" href="{% static 'core/events.css' %}">
    <script src="{% static 'core/events.js' %}" defer></script>
    <script src="{% static 'core/purchase.js' %}" defer></script>

    <style>
        .popup {
            position: fixed;
            top: 10vh;
            left: 50%;
            transform: translateX(-50%);
            width: 80vw;
            height: 80vh;
            background: #ffffff;
            color: #1f1f1f;
            z-index: 9999;
            border-radius: 16px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.35);
            display: flex;
            flex-direction: column;
            padding: 32px;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
        }

        .popup-content {
            position: relative;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .popup h2 {
            margin: 0 0 20px 0;
            font-size: 24px;
            font-weight: 700;
            border-bottom: 1px solid #e5e5e5;
            padding-bottom: 12px;
        }

        .events-scroll {
            overflow-y: auto;
            flex: 1;
            padding-right: 10px;
        }

        .participant-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 12px;
            align-items: center;
            padding: 14px;
            border-bottom: 1px solid #eee;
        }

        .status-chip {
            padding: 6px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            display: inline-block;
            width: 100px;
        }

        .status-chip.green {
            background-color: #dcfce7;
            color: #166534;
        }

        .status-chip.yellow {
            background-color: #fef9c3;
            color: #92400e;
        }

        .status-chip.red {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .toggle-group {
            display: flex;
            gap: 4px;
        }

        .toggle-group button {
            padding: 6px 10px;
            opacity: 0.3;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: #f1f1f1;
            font-size: 16px;
        }

        .toggle-group button.active {
            opacity: 1;
            background: #e0e7ff;
        }

        .popup .close-btn {
            position: absolute;
            top: 16px;
            right: 20px;
            font-size: 22px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
            transition: color 0.2s;
        }

        .popup .close-btn:hover {
            color: #e11d48;
        }

        .hidden {
            display: none !important;
        }

        .purchase-modal {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
.purchase-modal.hidden {
  display: none;
}
.purchase-modal-content {
  background: white;
  padding: 32px;
  border-radius: 16px;
  width: 80vw;
  max-height: 80vh;
  overflow-y: auto;
}
.event-button {
  display: block;
  margin: 8px 0;
  padding: 10px;
  border: 1px solid #ccc;
  background: #f3f3f3;
  cursor: pointer;
}

.purchase-modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.purchase-modal.hidden {
  display: none;
}

.purchase-modal-content {
  background: #fff;
  padding: 32px;
  border-radius: 16px;
  width: 80vw;
  max-height: 80vh;
  overflow-y: auto;
  color: #1f1f1f;
}

.event-button,
.resident-add-button,
.status-select {
  padding: 10px 14px;
  margin-top: 8px;
  border-radius: 8px;
  border: 1px solid #ccc;
  background: #f5f5f5;
  cursor: pointer;
  width: 100%;
  text-align: left;
}

.resident-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  margin-top: 8px;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 8px;
}

.resident-info {
  font-size: 16px;
}

.status-select {
  width: 160px;
}


    </style>
</head>
<body>
    <div class="vertical-waves">
        <div class="wave"></div>
        <div class="wave"></div>
        <div class="wave"></div>
    </div>

    <h1>Список событий</h1>
    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <button onclick="openEventPopup()">Добавить событие</button>
        <button onclick="openPurchaseModal()">Добавить покупку</button>
    </div>

    <table id="eventsTable">
        <thead>
            <tr>
                <th>№</th>
                <th>Название</th>
                <th>Дата</th>
                <th>Стоимость</th>
                <th>Всего мест</th>
                <th>Куплено</th>
                <th>Свободно</th>
                <th></th>
                <th></th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Попап: Добавление события -->
    <div id="event-popup-overlay" style="display: none;">
        <div id="popup">
            <h3>Новое событие</h3>
            <input id="eventNameInput" placeholder="Название">
            <input id="eventDateInput" type="date" placeholder="Дата">
            <input id="eventSeatsInput" type="number" placeholder="Всего мест">
            <input id="eventPriceInput" type="number" placeholder="Стоимость">
            <button onclick="addEvent()">Сохранить</button>
            <button onclick="closeEventPopup()">Закрыть</button>
        </div>
    </div>

    <!-- Попап: Завершение/активация -->
    <div id="popup-overlay" style="display: none;">
        <div id="popup-confirm">
            <p id="confirm-message">Вы уверены?</p>
            <div class="popup-buttons">
                <button id="confirm-yes">Да</button>
                <button id="confirm-no">Нет</button>
            </div>
        </div>
    </div>

<!-- Попап: Добавление покупки (старая логика + новый стиль) -->
<div id="purchaseModal" class="purchase-modal hidden">
  <div class="purchase-modal-content">
    <h1 id="purchaseStepTitle">Выберите ивент</h1>
    <div id="purchaseStepBody"></div>
    <div id="purchaseModalActions">
      <button onclick="closePurchaseModal()">Отмена</button>
    </div>
  </div>
</div>





    <!-- Попап: Участники события -->
    <div id="eventParticipantsPopup" class="popup hidden">
        <div class="popup-content">
            <span class="close-btn" onclick="closeParticipantsPopup()">×</span>
            <h2>Участники события</h2>
            <div id="participantsList" class="events-scroll"></div>
        </div>
    </div>


    <script>
const EVENTS_API_URL = '/api/events/';
const RESIDENTS_API_URL = '/api/residents/';
const PARTICIPATION_API_URL = '/api/participants/';

let selectedEventId = null;
let addedResidents = [];

function openPurchaseModal() {
  document.getElementById("purchaseModal").classList.remove("hidden");
  loadEventSelection();
}

function closePurchaseModal() {
  document.getElementById("purchaseModal").classList.add("hidden");
  selectedEventId = null;
  addedResidents = [];
  document.getElementById("purchaseStepTitle").textContent = "";
  document.getElementById("purchaseStepBody").innerHTML = "";
}

function loadEventSelection() {
  document.getElementById("purchaseStepTitle").textContent = "Выберите ивент";
  document.getElementById("purchaseModalActions").innerHTML = `<button onclick="closePurchaseModal()">Отмена</button>`;

  fetch(EVENTS_API_URL)
    .then(res => res.json())
    .then(events => {
      const body = document.getElementById("purchaseStepBody");
      body.innerHTML = "";
      events.forEach(event => {
        const btn = document.createElement("button");
        btn.textContent = `${event.title} — ${event.date}`;
        btn.className = "event-button";
        btn.onclick = () => {
          selectedEventId = event.id;
          loadResidentSelection();
        };
        body.appendChild(btn);
      });
    });
}

function loadResidentSelection() {
  document.getElementById("purchaseStepTitle").textContent = "Выберите резидента";
  const body = document.getElementById("purchaseStepBody");
  body.innerHTML = `
    <input type="text" id="residentSearchInput" placeholder="Поиск по ФИО или номеру..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 10px;">
    <div id="residentSearchResults"></div>
    <h3 style="margin-top: 20px;">Добавленные резиденты:</h3>
    <div id="addedResidentsList"></div>
  `;

  document.getElementById("purchaseModalActions").innerHTML = `
    <button onclick="submitPurchaseList()">Сохранить</button>
    <button onclick="closePurchaseModal()">Отмена</button>
  `;

  const input = document.getElementById("residentSearchInput");
  input.addEventListener("input", () => {
    const query = input.value.toLowerCase();
    if (query.length < 2) return;
    fetch(RESIDENTS_API_URL)
      .then(res => res.json())
      .then(data => {
        const results = data.filter(r =>
          (r.full_name + r.phone_number).toLowerCase().includes(query) &&
          !addedResidents.find(ar => ar.id === r.id)
        );
        showResidentSearchResults(results);
      });
  });
}

function showResidentSearchResults(results) {
  const container = document.getElementById("residentSearchResults");
  container.innerHTML = "";

  results.forEach(resident => {
    const btn = document.createElement("button");
    btn.className = "resident-add-button";
    btn.textContent = `${resident.full_name} (${resident.phone_number})`;
    btn.onclick = () => {
      addedResidents.push({ ...resident, status: "оплачено" });
      updateAddedResidentsUI();
      container.innerHTML = "";
      document.getElementById("residentSearchInput").value = "";
    };
    container.appendChild(btn);
  });
}

function updateAddedResidentsUI() {
  const list = document.getElementById("addedResidentsList");
  list.innerHTML = "";

  addedResidents.forEach(resident => {
    const div = document.createElement("div");
    div.className = "resident-item";

    const info = document.createElement("div");
    info.className = "resident-info";
    info.textContent = `${resident.full_name} (${resident.phone_number})`;

    const select = document.createElement("select");
    select.className = "status-select";
    ["оплачено", "забронировано", "оплачено частично"].forEach(status => {
      const opt = document.createElement("option");
      opt.value = status;
      opt.textContent = status;
      if (resident.status === status) opt.selected = true;
      select.appendChild(opt);
    });

    select.onchange = () => {
      resident.status = select.value;
    };

    div.appendChild(info);
    div.appendChild(select);
    list.appendChild(div);
  });
}

function submitPurchaseList() {
  if (!selectedEventId || addedResidents.length === 0) {
    alert("Выберите ивент и хотя бы одного резидента.");
    return;
  }

  const payload = addedResidents.map(r => ({
    event: selectedEventId,
    resident: r.id,
    status: r.status,
  }));

  fetch(PARTICIPATION_API_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify(payload)
  })
    .then(res => {
      if (res.ok) {
        alert("Покупки успешно сохранены");
        closePurchaseModal();
        // если нужно, перезагрузи список
      } else {
        alert("Ошибка при сохранении");
      }
    })
    .catch(() => alert("Сетевая ошибка"));
}
</script>

</body>
</html>
